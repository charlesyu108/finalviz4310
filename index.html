<!DOCTYPE html>
<html>

<head>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <link href="styles.css" rel="stylesheet"></link>
  <!-- mapbox -->
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.css' rel='stylesheet' />
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
</head>

<body>
  <h1>INFO 4310 Final Project</h1>
  <svg id="bubble-svg" width=800 height=600></svg>
  
  <div id="map" style="height:650px;width:500px;display:block"></div>
</body>

<script>
  //Loading in Data
  d3.queue()
    .defer(d3.csv, "profiles.csv")
    .await(makeViz);

  function makeViz(err, data) {
    console.log("Data Loaded!");

    var sampleData = {
      "children": [{
          "text": "hello",
          "count": 20
        },
        {
          "text": "artsy",
          "count": 200
        },
        {
          "text": "adventurous",
          "count": 145
        },
        {
          "text": "love",
          "count": 305
        },
        {
          "text": "harry potter",
          "count": 30
        },
        {
          "text": "game of thrones",
          "count": 13
        },
        {
          "text": "san francisco",
          "count": 155
        },
        {
          "text": "fun",
          "count": 300
        },
        {
          "text": "amp",
          "count": 70
        },

      ]
    }
    //NOTE!: The "children" field is very important to include!

    var bubble_svg = d3.select("#bubble-svg"),
      width = +bubble_svg.attr("width"),
      height = +bubble_svg.attr("height");

    var color = d3.scaleOrdinal(d3.schemeCategory20);

    var bubble = d3.pack(sampleData)
      .size([width, height])
      .padding(1.5);

    var bubble_tooltip = d3.select("body").append("div")
      .style("position", "absolute")
      .html("test");

    var nodes = d3.hierarchy(sampleData)
      .sum(d => d.count);

    var node = bubble_svg.selectAll(".node")
      .data(bubble(nodes).descendants())
      .enter()
      .filter(d => !d.children)
      .append("g")
      .attr("class", "node")
      .attr("transform", d => "translate(" + d.x + "," + d.y + ")");

    node.append("title")
      .text(d => d.data.text);

    node.append("circle")
      .attr("r", d => d.r)
      .style("fill", (d, i) => color(i));

    node.append("text")
      .attr("dy", ".2em")
      .attr("font-family", "sans-serif")
      .attr("text-anchor", "middle")
      .attr("font-size", (d => d.r / 5))
      .attr("fill", "white")
      .text(d => d.data.text)

    // Overlayed, transparent circle
    node.append("circle")
      .attr("class", "overlay")
      .attr("r", d => d.r)
      .style("opacity", 0)
      .on("mouseover", showToolTip)
      .on("mousemove", moveToolTip)
      .on("mouseout", hideToolTip);

    function moveToolTip(){
      bubble_tooltip
      .style("top", 12 + d3.event.pageY +"px")
      .style("left", 12 + d3.event.pageX+"px");
    }

    function showToolTip(){
      bubble_tooltip
      .style("display", "inline")
    }

    function hideToolTip(){
      bubble_tooltip
      .style("display", "none");
    }
  }

  //Bubble viz credit: https://bl.ocks.org/alokkshukla/3d6be4be0ef9f6977ec6718b2916d168
</script>

<script>

  mapboxgl.accessToken = 'pk.eyJ1IjoieHpwMiIsImEiOiJjamdpM3Z1dnUwaHZxMzFyemcycW9qMGhqIn0.5fbtsHMpGARMkk3qFmjTdA';
  var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/basic-v9',
  center: [-122.22297, 37.758972],
  zoom: 8.3
  });

  map.addControl(new mapboxgl.NavigationControl());

  map.on('load', function() {

    map.addSource("cities", {
        type: "geojson",
        data: "./cities.geojson"
    });

    map.addLayer({
      id: 'points',
      "interactive": true,
      type: 'circle',
      source: 'cities',
      paint: {
        'circle-radius': {
          property: 'users',
          type: 'exponential',
          stops: [
            [693, 15],
            [31064, 30]
          ]
        },
        'circle-opacity': 0.6,
        "circle-color": "red",
      },
    });

     map.addLayer({
        "id": "points-hover",
        "type": "circle",
        "source": "cities",
        "layout": {},
        "paint": {
          'circle-radius': {
              property: 'users',
              type: 'exponential',
              stops: [
                [693, 15],
                [31064, 30]
              ]
            },
            "circle-color": "red",
            "circle-opacity": 0.9
        },
        "filter": ["==", "city", ""]
    });

    map.addLayer({
        id: "cluster-count",
        type: "symbol",
        source: "cities",
        layout: {
            "text-field": "{users}",
            "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
            "text-size": 12,
            "text-allow-overlap": true
        }
    });

    map.on("mousemove", "points", function(e) {
      map.setFilter("points-hover", ["==", "city", e.features[0].properties.city]);
    });

    map.on('mouseenter', 'points-hover', function(e) {
          map.getCanvas().style.cursor = 'pointer';
    });

    map.on("mouseleave", "points", function() {
        map.setFilter("points-hover", ["==", "city", ""]);
    });

    map.on('click', 'points', function(e) {
      var coordinates = e.features[0].geometry.coordinates.slice();

      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML("<span style='font-size:16px;align:center'>"
                  +e.features[0].properties["city"]
                  +"</span>")
          .addTo(map);

    });

  });

/*var width = 600;
var height = 700;

var projection = d3.geoMercator()
    .center([37.631258, -122.2927387])
    .scale(225000)
    .translate([600 / 2, 700 / 2]);

var svg = d3.select("#map").append("svg")
    .attr("width", 600)
    .attr("height", 700)
    .attr("style", "border:1px solid #555;")
  
svg.append("svg:image")
  .attr("xlink:href", "sf_bayarea.svg")
  .attr("width", 424)
  .attr("height", 600)
  .attr("viewBox", "0 0 0 0");

d3.csv("cities.csv", function(data) {
  data.map(function(d) {
    console.log(d);
    var coords = projection([d.Longitude, d.Latitude]);
    console.log(coords);
    svg
      .append("circle")
      .attr("r",5)
      .attr("fill", "#000000")
      .attr("transform", "translate("+coords+")");
  });

});*/


</script>


</html>
