<!DOCTYPE html>
<html>

<head>
  <script src="https://d3plus.org/js/d3.js"></script>
  <script src="https://d3plus.org/js/d3plus.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <link href="styles.css" rel="stylesheet"></link>
  <script src="https://d3js.org/d3-collection.v1.min.js"></script>
  <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
  <script src="https://d3js.org/d3-quadtree.v1.min.js"></script>
  <script src="https://d3js.org/d3-timer.v1.min.js"></script>
  <script src="https://d3js.org/d3-force.v1.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>

  <style>
    div.tooltip { 
      position: absolute;     
      text-align: center;     
      width: 300px;          
      max-height: 300px;         
      padding: 8px;       
      font: 12px Open Sans;    
      background: lightsteelblue; 
      border: 1px solid steelblue;    
      border-radius: 8px;    
      overflow:auto; 
    }

  </style>

</head>

<body>
  <div class="jumbotron">
    <h1 class="display-5">The Online Dating Profile</h1>
    <p class="lead">A close look into the San Francisco dating scene</p>
  </div>
  <div id="demographics-div" style="position:relative">
  </div>
  <button id= "unsort">See Profiles</button>
  <button id="gender">Show Gender</button>
  <button id="age">Show Age</button>
  <button id="orientation"> Show Orientations </button>
  <button id="jobs"> Show Jobs </button>
  <div id="bubbles"></div> 

</body>


<script src="demographics.js"></script>

<script>

var width = 1200,
    height =550,
    padding = 1.5, // separation between same-color nodes
    clusterPadding = 6, // separation between different-color nodes
    maxRadius = 50;

var n = 200, // total number of nodes
    m = 2; // number of distinct clusters

var clusters = new Array(m);

d3.json("potato6.json", function(error, data) {
  if (error) throw error;

  var essayq = "essay4";

  nodes = [];

  var gender = "female";
  var jData = data.filter( d => (d.essay == essayq))[0];
  sampleData1 = {"children": jData.female.map(function (d){ return  {"text": d.word, "count": d.count, "gender": "f"} }) };
  femaletext = sampleData1.children.map(d => d.text);

  var gender = "male";
  var jData = data.filter( d => (d.essay == essayq))[0];
  sampleData2 = {"children": jData.male.map(function (d){ return  {"text": d.word, "count": d.count, "gender": "m"} }) };
  maletext = sampleData2.children.map(d => d.text);

  var gender = "both";
  var jData = data.filter( d => (d.essay == essayq))[0];
  top_both = jData.both.slice(50, 125);
  sampleData3 = {"children": top_both.map(function (d){ return  {"text": d.word, "count": d.count, "gender": "s"} }) };
  var sharedText = sampleData3.children.map(d => d.text);

  sampleData =  {"children": sampleData1.children.concat(sampleData2.children).concat(sampleData3.children)};

  var maleData = sampleData2.children; //.filter(d => sharedText.indexOf(d.text) == -1);
  var femaleData = sampleData1.children; //.filter(d => sharedText.indexOf(d.text) == -1);
  var sharedData = sampleData3.children;

  var mLen = d3.extent(maleData.map(function (item) {
          return (item.count);
      }));
  var fLen = d3.extent(femaleData.map(function (item) {
          return (item.count);
      }));
  var sLen = d3.extent(sharedData.map(function (item) {
          return (item.count);
      }));

  sampleData.children.forEach(function(point) {
      var i = getCluster(point);
      var col = getColor(point);
      var r = getRadius(point, mLen, fLen, sLen);
      var d = {
            cluster: i,
            radius: r,
            x: getX(i),
            y: (height) * Math.random(),
            color: col,
            text: point.text,
            count: point.count
          };
      if (!clusters[i] || (r > clusters[i].radius)) clusters[i] = d;
      nodes.push(d);
  });

  function getColor(point) {
    var fCol = "#ed6955";
    var mCol = "#7a7ac9";
    var sCol = "#9932CC";
    if(point.gender == "f") {
      return fCol;
    }
    else if(point.gender == "m") {
      return mCol;
    }
    else {
      return sCol;
    }
  }

  function getStroke(col) {
    var fCol = "#ed6955";
    var mCol = "#7a7ac9";
    var sCol = "#9932CC";
    if( col == fCol) {
      return "#d35847"
    }
    else if( col == mCol) {
      return "#6f6fbc"
    }
    else {
      return "#a17bb5"
    }
  }

  function getCluster(d) {
    if(d.gender == "f") {
      return 0;
    }
    else if(d.gender == "m") {
      return 2;
    }
    else {
      return 1;
    }
  }

  function getRadius(d, mLen, fLen, sLen) {
    if(d.gender == "f") {
      var scale = d3.scaleLinear().domain(fLen).range([10,50]);
      return scale(d.count)
    }
    else if(d.gender == 'm') {
      var scale = d3.scaleLinear().domain(mLen).range([10,50]);
      return scale(d.count)
    }
    else {
      var scale = d3.scaleLinear().domain(sLen).range([10,50]);
      return scale(d.count)
    }
  }

  function getX(i) {
    if(i==0) {
      return getRandom(0, width/3)
    }
    else if(i==1) {
      return getRandom(width/3, width*(2/3))
    }
    else {
      return getRandom(width*(2/3), width)
    }
  }

  function getRandom(min, max) {
    return Math.random() * (max - min) + min;
  }

  var force = d3.forceSimulation()

    // cluster by section
    .force('cluster', cluster()
      .strength(0.5))

    // apply collision with padding
    .force('collide', d3.forceCollide(d => d.radius + padding)
      .strength(0.7))

    .on('tick', layoutTick)
    .nodes(nodes);

  var tooltip = d3.select("body").append("div")   
        .attr("class", "tooltip")               
        .style("opacity", 0);

  var svg = d3.select("#bubbles").append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("style", "border:none");

  var elem = svg.selectAll("g")
      .data(nodes)
      .enter()
      .append("g")
      .on("mouseover", function(d) {
          d3.select(this).style("cursor", "pointer");
        })
      //.attr("transform", function(d){return "translate("+d.x+",80)"})

  elem.on("click", function(d,i) {
      displayText(d.text, d3.event.pageX, d3.event.pageY)
    })                  
    .on("mouseexit", function(d) {       
        tooltip.transition().duration(500).style("opacity", 0);   
    });

  var node = elem
      .append("circle")
      .style("fill", function(d) {return d.color})
      .style("stroke", function(d) {return  getStroke(d.color)})
      .style("opacity", 0.8)


  var label = elem
            .append("text")
              .text(function(d) {return d.text})
              .attr("class", "circleResize")
              .style("text-anchor", "middle")
              .style("fill", "#333")
              .style("font-family", "Open Sans")
              .style("font-size", 12);

  function displayText(word, pageX, pageY) {
    //document.getElementById("bubbleText").innerHTML = "";
    var first_essays = [];
    d3.csv("essays.csv", function(csv) {
      csv.map(function(row) {
        if(row.essay4.search(word) != -1) {
          first_essays.push(row.essay4);
        }
      });
      console.log(first_essays);

      var randEss = first_essays[Math.floor(Math.random() * first_essays.length)];

      /*var essays = [];
      for (var i = 0; i < 1; i++) {
          essays.push(first_essays[Math.floor(Math.random()*first_essays.length)]);
      }*/

      var startInd = randEss.search(word);
      var finalStr = randEss.slice(0,startInd) + "<span style='background-color:yellow;font-weight:bold'>" + word + "</span>" + randEss.slice(startInd+word.length);

      tooltip.transition().duration(200).style("opacity", .9);      
      tooltip.html(finalStr)  
        .style("left", (pageX) + "px")     
        .style("top", (pageY - 50) + "px"); 
    })
  }

  function layoutTick(e) {
    node
        .attr("cx", function(d) { return d.x = Math.max(d.radius, Math.min(width - d.radius, d.x)); })
        .attr("cy", function(d) { return d.y = Math.max(d.radius, Math.min(height - d.radius, d.y)); })
        .attr("r", function(d) { return d.radius; });
    label
        .attr("x", function(d) { return d.x} )
        .attr("y", function(d) { return d.y} );
  }

  // Move d to be adjacent to the cluster node.
  // from: https://bl.ocks.org/mbostock/7881887
  function cluster () {

    var nodes,
      strength = 0.1;

    function force (alpha) {

      // scale + curve alpha value
      alpha *= strength * alpha;

      nodes.forEach(function(d) {
        var cluster = clusters[d.cluster];
        if (cluster === d) return;

        let x = d.x - cluster.x,
          y = d.y - cluster.y,
          l = Math.sqrt(x * x + y * y),
          r = d.radius + cluster.radius;

        if (l != r) {
          l = (l - r) / l * alpha;
          d.x -= x *= l;
          d.y -= y *= l;
          cluster.x += x;
          cluster.y += y;
        }
      });

    }

    force.initialize = function (_) {
      nodes = _;
    }

    force.strength = _ => {
      strength = _ == null ? strength : _;
      return force;
    };

    return force;

  }

});

</script>
<!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script> -->
</html>
